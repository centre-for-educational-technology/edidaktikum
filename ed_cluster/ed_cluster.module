<?php

/**
 * @file
 * Cluster module.
 */

/**
 * Implements hook_menu().
 */
function ed_cluster_menu() {
  $items['clusters'] = array(
    'title' => t('Clusters'),
    'page callback' => 'ed_cluster_listing_page',
    'access callback' => TRUE,
    'weight' => 20,
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Clusters listing page.
 */
function ed_cluster_listing_page() {
  $content = array();
  $og_groups = ed_cluster_get_clusters();
  $account = $GLOBALS['user'];
  if(in_array('teacher', $account->roles)||in_array('administrator', $account->roles)){
    $content['add-new'] = array(
      '#type' => 'link',
      '#title' => t('Add new cluster'),
      '#href' => 'node/add/ed-cluster',
    );
  }
  if (!empty($og_groups)) {
    $nodes = node_load_multiple($og_groups);
    $build = node_view_multiple($nodes);
    $build['pager'] = array(
      '#theme' => 'pager',
      '#weight' => 5,
    );
    $content['clusters'] = $build;
  }
  return $content;
}

/**
 *
 */
function ed_cluster_get_clusters() {
  $query = db_select('node', 'n')
    ->extend('PagerDefault')
    ->fields('n', array('nid'))
    ->condition('n.status', 1)
    ->condition('n.type', 'ed_cluster')
    ->addTag('node_access')
    ->limit(ed_get_paging_nr());
  $nids = $query->execute()->fetchCol();
  return $nids;
}

/**
 * Implements hook_ctools_plugin_api().
 */
function ed_cluster_ctools_plugin_api() {
  list($module, $api) = func_get_args();
  if ($module == "page_manager" && $api == "pages_default") {
    return array("version" => "1");
  }
}

