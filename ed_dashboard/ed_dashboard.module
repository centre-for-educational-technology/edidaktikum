<?php

/**
 * @file
 * eDidaktikum dashboard module.
 */

/**
 * Implements hook_menu().
 */
function ed_dashboard_menu() {
  $items['dashboard'] = array(
    'title' => t('Dashboard'),
    'page callback' => 'ed_dashboard_page',
    'access callback' => 'user_is_logged_in',
    'weight' => -5,
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['dashboard/home'] = array(
    'title' => t('Dashboard'),
    'page callback' => 'ed_dashboard_page',
    'access callback' => 'user_is_logged_in',
    'weight' => 0,
    'menu_name' => 'ed-dashboard-menu',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Dashboard page.
 */
function ed_dashboard_page() {
  menu_tree_set_path('main-menu', 'dashboard');
 
  $content = array();

  $group_nids = _ed_dashboard_get_current_user_groups();
  if (!empty($group_nids)) {
    $groups = node_load_multiple($group_nids);
  }

  if (!empty($groups)) {
    $content['groups-listing'] = node_view_multiple($groups, 'dashboard');
    $content['groups-listing']['pager'] = array(
      '#theme' => 'pager',
      '#weight' => 5,
    );
  }
 
  return $content; 
}

/**
 * Returns ed_cluster node identifiers that current user is an active
 * member of.
 * Uses pager extender.
 */
function _ed_dashboard_get_current_user_groups() {
  $acc = $GLOBALS['user'];
  $query = db_select('node', 'n')
    ->extend('PagerDefault')
    ->limit(ed_get_paging_nr());
  $query->join('og_membership', 'ogm', "n.nid = ogm.gid AND ogm.entity_type = 'user' AND ogm.state = :active AND ogm.etid = :uid", array(':active' => OG_STATE_ACTIVE, ':uid' => $acc->uid));
  $query->fields('n', array('nid'))
    ->condition('n.type', 'ed_cluster')
    ->addTag('node_access');

  return $query->execute()->fetchCol();
}

