<?php

/**
 * @file
 * eDidaktikum portfolio module.
 */

/**
 * Implements hook_menu().
 */
function ed_q_portfolio_menu() {
  $items['dashboard/qualification_portfolio'] = array(
    'title' => t('Qualification Portfolio'),
    'page callback' => 'ed_q_portfolio_listing_page',
    'access callback' => 'user_is_logged_in',
    'weight' => 5,
    'menu_name' => 'ed-dashboard-menu',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}


//function ed_form_tase($form, &$form_state) {
//
//  $form["tase_select"] = array(
//      "#type" => "select",
//      "#title" => t("Mis on sinu tase"),
//      "#default_value" => variable_get("tase_select", "tase1"),
//      "#options" => array(
//          "tase1" => t("Tase 1"),
//          "tase2" => t("Tase 2"),
//          "tase3" => t("Tase 3"),
//      ),
//      "#description" => t("Vali taset"),
//  );
//
//  $form['submit_button'] = array(
//      '#type' => 'submit',
//      '#value' => t('Click Here!'),
//  );
//
//  return $form;
//}
//
//function ed_form_tase_validate($form, &$form_state) {
//  if (!($form_state['values']['price'] > 0)){
//    form_set_error('price', t('Price must be a positive number.'));
//  }
//}
//
//function ed_form_tase_submit($form, &$form_state) {
//}


//function get_all_leaves(&$leaves, $term){
//  if (isset($term->children)) {
//    foreach($term->children as $child) {
//      get_all_leaves($leaves, $child);
//    }
//  } else {
//    $leaves[$term->tid] = $term;
//  }
//}
//
//
///**
// *
// * @param type $vocabulary - Competence vocabulary with term->done = true as acquired competence
// * @return type array - Full competency profile
// */
//function _ed_get_competency_profile($vocabulary){
//
//  $profile = array();
//  return $profile;
//}
//
//
//
/**
 * https://api.drupal.org/comment/50023#comment-50023
 */
//function taxonomy_get_nested_tree($vid_or_terms = array(), $max_depth = NULL, $parent = 0, $parents_index = array(), $depth = 0) {
//
//  if (!is_array($vid_or_terms)) {
//    $vid_or_terms = taxonomy_get_tree($vid_or_terms);
//  }
//
//  foreach ($vid_or_terms as $term) {
//
//    foreach ($term->parents as $term_parent) {
//      if ($term_parent == $parent) {
//        $return[$term->tid] = $term;
//      }
//      else {
//        $parents_index[$term_parent][$term->tid] = $term;
//      }
//    }
//  }
//
//  foreach ($return as &$term) {
//    if (isset($parents_index[$term->tid]) && (is_null($max_depth) || $depth < $max_depth)) {
//      $term->children = taxonomy_get_nested_tree($parents_index[$term->tid], $max_depth, $term->tid, $parents_index, $depth + 1);
//    }
//  }
//
//  return $return;
//}

/**
 * Portfolios listing page.
 */
function ed_q_portfolio_listing_page(){
  menu_tree_set_path('main-menu', 'dashboard');
  //drupal_add_css('ul.links.inline {display: none;}', array('group' => CSS_THEME, 'type' => 'inline'));
  $content = array();

  $content['add-new-container'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array('ed-add-new-node', 'ed-add-new-ed-portfolio'),
    ),
  );
  $content['add-new-container']['add-new-portfolio'] = array(
    '#type' => 'link',
    '#title' => t('Add new portfolio'),
    '#href' => 'node/add/ed-q-portfolio',
  );

  $table_type = 'pager-table';
  $user_portfolio_ids = ed_q_portfolio_get_user_portfolios();
  //$user_portfolio_ids = array();
  $nodes = node_load_multiple($user_portfolio_ids);
  $rows = array();
  foreach($nodes as $node){
    if($node->status=='1'){
      $status = '<span class="pub-portfolio">'.t('Public').'</span>';
    }else if($node->status=='0'){
      $status = '<span class="priv-portfolio">'.t('Private').'</span>';
    }else{
      $status = t('error');
    }
    $rows[] = array(
      'data' => array(
        'status' => $status,
        'title' => l($node->title, 'node/'.$node->nid),
        'created' => format_date($node->created, 'custom', 'd/m/Y'),
      ),
    );
  }
  $content[$table_type] = array(
    '#theme' => 'table',
    '#rows' => $rows,
    '#header' => array(t('Status'), t('Title'), t('Date')),
  );
  $content['pager'] = array('#theme' => 'pager');

  drupal_add_css('span.pub-portfolio {color:green;}', array('group' => CSS_THEME, 'type' => 'inline'));
  drupal_add_css('span.priv-portfolio {color:red;}', array('group' => CSS_THEME, 'type' => 'inline'));


  return $content;
}

/**
 * User portfolio ids.
 */
function ed_q_portfolio_get_user_portfolios() {
  global $user;
  $query = db_select('node', 'n')
      ->fields('n', array('nid'))
      ->condition('n.type', 'ed_q_portfolio')
      ->condition('n.uid', $user->uid)
      ->addTag('node_access')
      ->range()
      ->orderBy('n.created', 'DESC');
  $nids = $query->execute()->fetchCol();
  return $nids;
}


/**
 * Implements hook_field_extra_fields().
 */
function ed_q_portfolio_field_extra_fields(){
  $extra['node']['ed_q_portfolio']['display'] = array(
      'ed_q_portfolio_level' => array(
          'label' => t('Qualification level container'),
          'description' => t('Qualification level container'),
          'weight' => 10,
      ),
  );
  return $extra;
}

/**
 * Implements hook_node_view().
 */
function ed_q_portfolio_node_view($node, $view_mode, $langcode) {
  if ('ed_q_portfolio' == $node->type) {
    if (in_array($view_mode, array('full'))) {
      $field_tase = $node->ed_q_portfolio_field_level;

      $term = taxonomy_term_load($field_tase[LANGUAGE_NONE][0]['tid']);

      $vocabulary = taxonomy_get_tree(taxonomy_vocabulary_machine_name_load('ed_qualification_voc')->vid, $term->tid);

      dpm($vocabulary);


      $node->content['ed_q_portfolio_level'] = array(
          '#type' => 'item',
          '#label_display' => 'above',
          '#markup' => $term->name,
      );
      //$name = $term->name;


//      $field_end = $node->ed_event_field_end[LANGUAGE_NONE][0];
//      $node->content['start-end-dates'] = array(
//          '#type' => 'container',
//          '#attributes' => array(
//              'class' => array('submitted'),
//          ),
//          '#weight' => -1,
//      );
//      $node->content['start-end-dates']['start'] = array(
//          '#type' => 'markup',
//          '#markup' => vsprintf("%s - %s", array(
//              format_date($field_start['value'], 'short', '', $field_start['timezone']),
//              format_date($field_end['value'], 'short', '', $field_end['timezone']),
//          )),
//          '#prefix' => '<span>',
//          '#suffix' => '</span>',
//      );
    }
  }
}


///**
// * Implements hook_preprocess_node().
// */
//function ed_q_portfolio_preprocess_node(&$vars) {
//  dpm($vars);
//}



//
//function ed_q_portfolio_theme($existing, $type, $theme, $path) {
//  return array(
//    'ed_q_portfolio_page' => array(
//      'variables' => array('node_view' => '', 'site_name' => variable_get('site_name', 'Drupal'), 'front_page' => variable_get('site_frontpage')),
//      'template' => 'ed_q_portfolio_page',
//      'path' => drupal_get_path('module', 'ed_q_portfolio'),
//      'render element' => 'element',
//    ),
//  );
//}
//
//
//
///**
// * Implements hook_ctools_plugin_api().
// */
//function ed_q_portfolio_ctools_plugin_api() {
//  list($module, $api) = func_get_args();
//  if ($module == "page_manager" && $api == "pages_default") {
//    return array("version" => "1");
//  }
//}
//
//
//
///**
// * Implements hook_views_api().
// */
//function ed_q_portfolio_views_api() {
//  return array(
//    'api' => 3,
//    'path' => drupal_get_path('module', 'ed_q_portfolio') . '/includes/views',
//  );
//}
//
///**
// * Implements hook_form_alter().
// */
//function ed_q_portfolio_form_alter(&$form, &$form_state, $form_id) {
//  if ('ed_q_portfolio_node_form' == $form_id) {
//    if (empty($form['#node']->nid)) {
//      drupal_set_title(t('Create Portfolio'));
//    }
//  }
//}

