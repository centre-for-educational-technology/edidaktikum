<?php

/**
 * @file
 * eDidaktikum module.
 */

require("edf.php");

/**
 * Email to be used with automatic system messages
 */
define('EDIDAKTIKUM_NO_REPLY_EMAIL', 'no-reply@edidaktikum.ee');

/**
 * Implements hook_init().
 */
function edidaktikum_init() {
	//Used by ed_g_drive Google Drive files integration
	drupal_add_js('https://apis.google.com/js/api.js?onload=loadPicker', array('type' => 'external', 'defer' => 'defer'));
	
	$uservoice_api_key = variable_get('ed_uservoice_api_key');
  if (!empty($uservoice_api_key)) {
    global $language;
    drupal_add_js(array(
      'edidaktikum' => array(
        'ed_uservoice_api_key' => $uservoice_api_key,
        'locale' => $language->language,
      ),
    ), 'setting');
    if (user_is_logged_in()) {
      $acc = $GLOBALS['user'];
      drupal_add_js(array(
        'edidaktikum' => array(
          'authenticated' => true,
          'email' => $acc->mail,
          'name' => edidaktikum_get_full_name_for_user_account($acc),
          'created_at' => $acc->created,
          'id' => $acc->uid,
        ),
      ), 'setting');
    }
  }
  if(isset($_COOKIE['Drupal_visitor_edidaktikum_logoff'])){
    if($_COOKIE['Drupal_visitor_edidaktikum_logoff'] == 1){
      drupal_set_message(t('Goodbye! You are now logged out from eDidaktikum'));
      user_cookie_save(array('edidaktikum.logoff' => '0'));
    }
  }
}

function edidaktikum_page_build(&$page){
  if(variable_get('ed_home_page_intro_notification_message') && drupal_is_front_page()){
    $page['page_top']['ed_notice'] = array(
      '#type' => 'markup',
      '#markup' => '<div class="ed-front-page-notice-container"><div class="ed-front-page-notice">'.variable_get('ed_home_page_intro_notification_message').'</div></div>'
    );
  }
}


/**
 * Implements hook_menu().
 */
function edidaktikum_menu() {
  $items['admin/config/edidaktikum'] = array(
    'title' => 'eDidaktikum',
    'description' => 'Administer eDidaktikum modules.',
    'position' => 'right',
    'weight' => -10,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  $items['admin/config/edidaktikum/home-page'] = array(
    'title' => 'eDidaktikum home page',
    'description' => 'Configure eDidaktikum home page.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edidaktikum_home_page_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'edidaktikum.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 0,
  );
  $items['admin/config/edidaktikum/contact-page'] = array(
    'title' => 'eDidaktikum contact page',
    'description' => 'Configure edidaktikum contact page.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edidaktikum_contact_page_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'edidaktikum.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 1,
  );
  $items['admin/config/edidaktikum/faq-page'] = array(
    'title' => 'eDidaktikum FAQ page',
    'description' => 'Configure edidaktikum FAQ page.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edidaktikum_faq_page_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'edidaktikum.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 2,
  );
	
	$items['admin/config/edidaktikum/pp-page'] = array(
			'title' => 'eDidaktikum Privacy Policy page',
			'description' => 'Configure edidaktikum Privacy Policy page.',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('edidaktikum_pp_page_admin_form'),
			'access arguments' => array('access administration pages'),
			'file' => 'edidaktikum.admin.inc',
			'type' => MENU_NORMAL_ITEM,
			'weight' => 2,
	);
	$items['for-schools'] = array(
			'title' => 'Koolile',
			'page callback' => 'edidaktikum_schools_page',
			'access callback' => TRUE,
			'file' => 'edidaktikum.pages.inc',
			'weight' => 25,
			'menu_name' => 'main-menu',
			'type' => MENU_NORMAL_ITEM,
	);

  $items['admin/config/edidaktikum/promoted-news'] = array(
    'title' => 'eDidaktikum Promoted News',
    'description' => 'Choose front page News',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edidaktikum_promoted_news_page_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'edidaktikum.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 3,
  );
  $items['admin/config/edidaktikum/promoted-events'] = array(
    'title' => 'eDidaktikum Promoted Events',
    'description' => 'Choose front page Event',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edidaktikum_promoted_events_page_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'edidaktikum.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 4,
  );
  $items['admin/config/edidaktikum/promoted-resources'] = array(
    'title' => 'eDidaktikum Promoted Resources',
    'description' => 'Choose front page Learning Resource',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edidaktikum_promoted_resources_page_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'edidaktikum.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 5,
  );
  $items['admin/config/edidaktikum/statistics'] = array(
    'title' => 'eDidaktikum Statistics',
    'description' => 'Statistics about the eDidaktikum web page',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edidaktikum_statistics_page_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'edidaktikum.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 6,
  );
  $items['admin/config/edidaktikum/configuration'] = array(
    'title' => t('eDidaktikum Configuration'),
    'description' => t('Configuration settings for eDidatkikum'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edidaktikum_configuration_page_admin_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'edidaktikum.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 7,
  );
  $items['home'] = array(
    'title' => 'Home',
    'page callback' => 'edidaktikum_home_page',
    'access callback' => TRUE,
    'file' => 'edidaktikum.pages.inc',
    'weight' => 0,
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['contact'] = array(
    'title' => 'Contact',
    'page callback' => 'edidaktikum_contact_page',
    'access callback' => TRUE,
    'file' => 'edidaktikum.pages.inc',
    'weight' => 25,
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['faq'] = array(
    'title' => 'FAQ',
    'page callback' => 'edidaktikum_faq_page',
    'access callback' => TRUE,
    'file' => 'edidaktikum.pages.inc',
    'weight' => -25,
    'menu_name' => 'user-menu',
  );
	$items['privacy'] = array(
			'title' => 'Privacy Policy',
			'page callback' => 'edidaktikum_pp_page',
			'access callback' => TRUE,
			'file' => 'edidaktikum.pages.inc',
			'weight' => -25,
			'menu_name' => 'user-menu',
	);
  $items['node/%/edidaktikum/action/like'] = array(
    'page callback' => 'edidaktikum_node_like',
    'page arguments' => array(1),
    'type' => MENU_CALLBACK,
    'access callback' => 'user_is_logged_in',
  );
  $items['edidaktikum/autocomplete/from/group/%'] = array(
    'page callback' => 'testimeee',
    'page arguments' => array(4),
    'theme callback' => 'ajax_base_page_theme',
    'access callback' => 'user_access',
    'access arguments' => array('access user profiles'),
    'type' => MENU_CALLBACK,
  );
  $items['ed-delete/%/%'] = array(
    'title' => '',
    'page callback' => 'edidaktikum_node_delete_page',
    'access callback' => true,
    'page arguments' => array(1, 2),
  );



  return $items;
}


function edidaktikum_node_delete_page($groups, $deletedtitle){
  
  $content = array();
  parse_str($groups, $groupsarray);

  $groups = node_load_multiple($groupsarray);
  
  drupal_set_title($deletedtitle);
  $content['delete-page'] = array(
    '#type' => 'markup',
    '#markup' => t('Continue to group page: '),
  );
  $content['delete-page-groups']['wrapper'] = array(
    '#type' => 'markup',
    '#markup' => '',
    '#prefix' => '<ul>',
    '#suffix' => '</ul>',
  );
  foreach($groups as $group){
    $content['delete-page2-groups']['wrapper'][$group->nid] = array(
      '#type' => 'markup',
      '#markup' => l($group->title, 'node/'.$group->nid),
      '#prefix' => '<li>',
      '#suffix' => '</li>',
    );
  }
  
  return $content;
}


function testimeee($gid, $string = ''){
  //used some code from Views module.
  $group_members_ids = og_get_group_members_properties(node_load($gid), array(), 'members', 'node');
  $group_members = user_load_multiple($group_members_ids);
  
  $array = drupal_explode_tags($string);
  $last_string = trim(array_pop($array));
  
  $allmembers = array();
  foreach($group_members as $member) {
    $allmembers[$member->uid] = check_plain($member->ed_field_full_name[LANGUAGE_NONE][0]['safe_value']);
  }
  $result = array();
  foreach($allmembers as $uid => $name){
    if(strpos(strtolower($name), strtolower($last_string)) !== FALSE){
      $result[$uid] = check_plain($name);
    }
  }
  
  $matches = array();
  $prefix = count($array) ? implode(', ', $array) . ', ' : '';
  foreach ($result as $uid => $account) {
      $n = $account;
      $userobj = user_load($uid);
      if (strpos($account, ',') !== FALSE || strpos($account, '"') !== FALSE) {
        $n = '"' . str_replace('"', '""', $userobj->name) . '"';
      }
      $matches[$prefix . $userobj->name] = check_plain($account);
    }
  
  drupal_json_output($matches);
}

/**
 * Custom callback for user label.
 * Uses fullname if available.
 * Defaults to format_username.
 */
function edidaktikum_user_label_callback($account) {
  $fullnames = field_get_items('user', $account, 'ed_field_full_name');
  if (isset($fullnames[0]['value'])) {
    return $fullnames[0]['value'];
  }
  return format_username($account);
}

/**
 * Tries to return user full_name for an account if possible.
 * In case there is not full_name set formatted username is returned.
 */
function edidaktikum_get_full_name_for_user_account(&$account) {
  if (isset($account->ed_field_full_name['und'][0]['safe_value'])) {
    return $account->ed_field_full_name['und'][0]['safe_value'];
  }
  return format_username($account);
}

function edidaktikum_entity_info_alter(&$entity_info) {
  $entity_info['node']['view modes']['featured'] = array(
    'label' => t('Featured'),
    'custom settings' => TRUE,
  );
  $entity_info['node']['view modes']['front'] = array(
    'label' => t('Front'),
    'custom settings' => TRUE,
  );
  $entity_info['node']['view modes']['dashboard'] = array(
    'label' => t('Dashboard'),
    'custom settings' => TRUE,
  );
  $entity_info['node']['view modes']['eref_contained'] = array(
    'label' => t('Entity Reference Contained'),
    'custom settings' => TRUE,
  );
  if (isset($entity_info['user'])) {
    $entity_info['user']['label callback'] = 'edidaktikum_user_label_callback';
  }
}
function edidaktikum_node_view($node, $view_mode, $langcode){
  $typestochange = array('ed_learning_resource', 'ed_event', 'ed_news');
  if(in_array($node->type, $typestochange) && $view_mode=='teaser'){
    if(!empty($node->ed_field_featured_image)){
      $imgpath = image_style_url('thumbnail', $node->ed_field_featured_image[LANGUAGE_NONE][0]['uri']);
      
      $node->content['cover-image'] = array(
        '#type' => 'markup',
        '#weight' => 55,
        '#markup' => '<img src="'.$imgpath.'"/>',
        '#prefix' => '<div class="cover-image">',
        '#suffix' => '</div>',
      );
      
    }
  }
}

/**
 * Implements ctools_render_alter().
 *
 * This is done since hook_node_view never gets called if the node is rendered by Ctools.
 */
function edidaktikum_ctools_render_alter($info, $page, $context) {
  
  
  $node = node_load($context['args'][0]);
  
  if(!empty($node) && $node->status==0){
    $nodetype = node_type_get_type($node);
    
    $markup = '<p class="unpublished-warning">'.t('@type <b>@title</b> has been created, but not published. At the moment, only you can see it.', array('@type' => $nodetype->name, '@title' => $node->title)).'</p>';
    
    drupal_set_message($markup);
  }
}











/**
 * Implements hook_preprocess_node().
 */
function edidaktikum_preprocess_node(&$vars) {
  if ($vars['view_mode'] == 'featured') {
    $vars['featured'] = TRUE;
    $vars['theme_hook_suggestions'][] = 'node__featured';
    $vars['theme_hook_suggestions'][] = 'node__' . $vars['type'] . '__featured';
    $vars['user_picture'] = '';
  }
  if ($vars['view_mode'] == 'front') {
    $vars['front'] = TRUE;
    $vars['theme_hook_suggestions'][] = 'node__front';
    $vars['theme_hook_suggestions'][] = 'node__' . $vars['type'] . '__front';
    $vars['user_picture'] = '';
  }
  if ($vars['view_mode'] == 'dashboard') {
    $vars['dashboard'] = TRUE;
    $vars['theme_hook_suggestions'][] = 'node__dashboard';
    $vars['theme_hook_suggestions'][] = 'node__' . $vars['type'] . '__dashboard';
  }
  if ($vars['view_mode'] == 'eref_contained') {
    $vars['eref_contained'] = TRUE;
    $vars['theme_hook_suggestions'][] = 'node__eref_contained';
    $vars['theme_hook_suggestions'][] = 'node__' . $vars['type'] . '__eref_contained';
    $vars['user_picture'] = '';
  }
  if ('teaser' === $vars['view_mode'] && $vars['type'] !== 'ed_portfolio') {
    if (TRUE === $vars['logged_in'] && $vars['uid'] === $vars['user']->uid) {
      $vars['classes_array'][] = 'ed-node-mine';
    }
  }
  if (in_array($vars['view_mode'], array('teaser'))) {
    $vars['user_picture'] = '';
  }
}

function ed_get_paging_nr(){
  return variable_get('ed_paging');
}

function ed_get_grid_paging_nr(){
  return variable_get('ed_grid_paging');
}

function _ed_get_sorting_options($form_state){
  $form = array();
  $form['select'] = array(
    '#type' => 'select',
    '#options' => drupal_map_assoc(array(t('Latest First'), t('Earliest First'), t('Title (A-Z)'))),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Sort'),
  );
  return $form;
}


function _ed_get_sorting_options_submit($form, &$form_state) {
  
  $sortorder = $form_state['values']['select'];
  switch($sortorder){
    case t('Latest First'):
      $sortordermn = 'DESC';
    break;
    case t('Earliest First'):
      $sortordermn = 'ASC';
    break;
    case t('Title (A-Z)'):
      $sortordermn = 'title';
    break;
  }
  drupal_goto(current_path(),array('query' => array('order' => $sortordermn)));
}

/**
 * Determine ordering for sql query and modify sorting form.
 * @param array $content A drupal Form API array of the page content.
 * @return string Ordering type.
 */
function ed_get_sorting_type(&$content){
  $sql_order = 'DESC';
  if(isset($_GET['order'])){
    $order = $_GET['order'];
    switch($order){
      case 'ASC':
        $content['sorting']['select']['#value'] = t('Earliest First');
        $sql_order = 'ASC';
      break;
      case 'title':
        $content['sorting']['select']['#value'] = t('Title (A-Z)');
        $sql_order = 'title';
      break;
      case 'DESC':
      default:
        $content['sorting']['select']['#value'] = t('Latest First');
        $sql_order = 'DESC';
      break;
    }
  }
  return $sql_order;
}



/**
 * Implements hook_form_alter().
 */
function edidaktikum_form_alter(&$form, $form_state, $form_id) {
  if($form_id=='views_exposed_form'){
    if($form_state['view']->name == 'og_members_admin'){
      $form['uid']['#autocomplete_path'] = 'edidaktikum/autocomplete/from/group/'.$form_state['view']->args[1];
    }
  }
  
  // If not a blog post, then student can only set Group content visibility to private
  // Remove any other options from the node edit form
  if (!empty($form['#node_edit_form']) && isset($form['group_content_access'])) {
    $account = $GLOBALS['user'];
    if (!(in_array('teacher', $account->roles) || in_array('administrator', $account->roles))) {
      if($form['type']['#value'] != 'ed_blog'){
        unset($form['group_content_access']['und']['#options'][0]);
        unset($form['group_content_access']['und']['#options'][1]);
      }

    }
  }

  // Allow any to set node published or not
  if (!empty($form['#node_edit_form'])) {
    $account = $GLOBALS['user'];
    if (!in_array('administrator', $account->roles)) {
      $form['options']['#access'] = TRUE;
      $form['options']['promote']['#access'] = FALSE;
      $form['options']['sticky']['#access'] = FALSE;
    }
  }

  $form['#attached']['js'][] = drupal_get_path('module', 'edidaktikum') . '/edidaktikum.js';
  $form['#attached']['css'][] = drupal_get_path('module', 'edidaktikum') . '/edidaktikum.css';

  // Alter node delete form and add own redirect handler logic
  if ('node_delete_confirm' == $form_id) {
    $form['actions']['submit']['#submit'][] = 'node_delete_confirm_submit';
    $form['actions']['submit']['#submit'][] = '_edidaktikum_node_delete_redirect';
  }
}

/*
 * Implements hook_attach_submit().
 */

function edidaktikum_field_attach_submit($entity_type, $entity, $form, &$form_state){
  if(isset($entity->ed_field_category) && $entity->ed_field_category){
    $parentArray = array();
    $parents = array();
    foreach($entity->ed_field_category[LANGUAGE_NONE] as $ta){
      _check_for_parents($ta['tid'], $parentArray);
    }
    if (is_array($parentArray) && sizeof($parentArray) > 0) {
      foreach ($parentArray as $stid) {
        if(!in_array(array('tid' => $stid), $entity->ed_field_category[LANGUAGE_NONE])){
          array_push($entity->ed_field_category[LANGUAGE_NONE], array('tid' => $stid));
        }
      }
    }
  }
}

function _check_for_parents($tid, &$parentArray){
  $parent = taxonomy_get_parents($tid);
  if(!empty($parent)) {
    $parent = reset($parent);
    array_push($parentArray, $parent->tid);
    _check_for_parents($parent->tid, $parentArray);
  }
}

/**
 * Returns identifiers for promoted node of type provided or false.
 * @param $node_type
 *   Node type to check promoted for
 */
function ed_get_promoted_by_node_type($node_type) {
  $query = db_select('node', 'n');
  $query->fields('n', array('nid'))
    ->addTag('node_access')
    ->condition('n.type', $node_type)
    ->condition('n.status', 1)
    ->condition('n.promote', 1)
    ->orderBy('n.created', 'DESC');
  $nids = $query->execute()->fetchCol();
  if( !empty($nids) ) {
    return $nids;
  }
  return FALSE;
}

/**
 * Returns identifiers for draft nodes of type provided or false.
 * @param $node_type
 *   Node type to check promoted for
 */
function ed_get_drafts_by_node_type($node_type) {
  $query = db_select('node', 'n');
  $query->fields('n', array('nid'))
    ->addTag('node_access')
    ->condition('n.type', $node_type)
    ->condition('n.status', 0)
    ->orderBy('n.created', 'DESC');
  $nids = $query->execute()->fetchCol();
  if( !empty($nids) ) {
    return $nids;
  }
  return FALSE;
}

/**
 * Implements hook_user_login().
 */
function edidaktikum_user_login(&$edit, $account) {
  // Redirect to dashboard in case of user login
  if (isset($edit['values']['form_id']) && 'user_login' == $edit['values']['form_id']) {
    $edit['redirect'] = 'dashboard';
  }
}

/**
 * Implements hook_user_view_alter().
 */
function edidaktikum_user_view_alter(&$build) {

  if ('full' == $build['#view_mode']) {
    if(isset($build['ed_field_full_name'])){
      $build['ed_field_full_name']['#title'] = t('E-mail');
      $build['ed_field_full_name'][0]['#markup'] = '<a href="mailto:'.$build['#account']->mail.'?subject=eDidaktikum e-mail">'.$build['#account']->mail.'</a>';
    }
    if(!isset($build['ed_user_view_email'])){
    
    }
    if (isset($build['og_user_node']) && is_array($build['og_user_node']) && !empty($build['og_user_node']) && !empty($build['og_user_node']['#items'])) {
      $items_nodes = node_load_multiple(array_map(function ($item) {
        return $item['target_id'];
      }, $build['og_user_node']['#items']));

      //Sort inactive groups
      foreach(array_values($items_nodes) as $index => $item_node) {
        if (isset($item_node->ed_field_group_state) && $item_node->ed_field_group_state[LANGUAGE_NONE][0]['value'] == 0) {
          $build['og_user_node'][$index]['#attributes'] = array('class' => 'ed_group_inactive');
          $build['og_user_node']['#items'][$index]['weight'] = 10;
        }
        //Not belonging to ed_cluster, subgroup
        else if(!isset($item_node->ed_field_group_state)){
          unset($build['og_user_node'][$index]);
        }
      }
      uasort($build['og_user_node']['#items'], 'drupal_sort_weight');

      // Checks if last element of the array is just a #markup
      // and removes if that is true
      $last = end($build['og_user_node']);
      reset($build['og_user_node']);
      if (isset($last['#markup'])) {
        array_pop($build['og_user_node']);
      }
      unset($last);

    }
    if (isset($build['summary'])) {
      $build['summary']['#title'] = '';
    }
    if (isset($build['hybridauth_identities'])) {
      unset($build['hybridauth_identities']);
    }
    
  }
}

/**
 * Set redirect location on delete of own node types.
 */
function _edidaktikum_node_delete_redirect($form, &$form_state) {
  // Check if group set and grab first group URL
  
  /*
  if (!empty($form['#node']->og_group_ref[LANGUAGE_NONE])) {
    $group_url = url('node/' . $form['#node']->og_group_ref[LANGUAGE_NONE][0]['target_id'], array('absolute' => TRUE));
  }

  // Set $redirect_url if possible
  switch($form['#node']->type) {
      case 'ed_answer':
        $redirect_url = 'dashboard/tasks';
        break;
      case 'ed_blog':
        if (!empty($group_url)) {
          $redirect_url = $group_url . '/blog';
        } else {
          $redirect_url = 'dashboard/blogs';
        }
        break;
      case 'ed_bookmark':
        if (!empty($group_url)) {
          $redirect_url = $group_url . '/bookmark';
        }
        break;
      case 'ed_forum':
        if (!empty($group_url)) {
          $redirect_url = $group_url . '/forum';
        }
        break;
      case 'ed_event':
        if (!empty($group_url)) {
          $redirect_url = $group_url . '/event';
        } else {
          $redirect_url = 'events';
        }
        break;
      case 'ed_file_folder':
        $redirect_url = 'dashboard/files';
        break;
      case 'ed_file':
        $redirect_url = 'dashboard/files';
        break;
      case 'ed_cluster':
        $redirect_url = 'clusters';
        break;
      case 'ed_learning_resource':
        if (!empty($group_url)) {
          $redirect_url = $group_url . '/learning-resource';
        } else {
          $redirect_url = 'resources';
        }
        break;
      case 'ed_news':
        if (!empty($group_url)) {
          $redirect_url = $group_url . '/news';
        } else {
          $redirect_url = 'news';
        }
        break;
      case 'ed_page':
        if (!empty($group_url)) {
          $redirect_url = $group_url . '/page';
        }
        break;
      case 'ed_portfolio':
        $redirect_url = 'dashboard/portfolio';
        break;
      case 'ed_task':
        if (!empty($group_url)) {
          $redirect_url = $group_url . '/task-manager';
        } else {
          $redirect_url = 'dashboard/tasks';
        }
        break;
  }
  
  // Force redirect if $redirect_url not empty
  if (!empty($redirect_url)) {
    $form_state['redirect'] = $redirect_url;
  }*/
  if (!empty($form['#node']->og_group_ref[LANGUAGE_NONE])) {
    $groups = array();
    foreach($form['#node']->og_group_ref[LANGUAGE_NONE] as $group){
      array_push($groups, $group['target_id']);
    }
    $groups = drupal_http_build_query($groups);
    $form_state['redirect'] = 'ed-delete/'.$groups.'/'.$form['#node']->title;
  }else{
    $form_state['redirect'] = 'dashboard';
  }
}

/**
 * Implements hook_username_alter().
 */
function edidaktikum_username_alter(&$name, $account) {
  // Don't alter anonymous users or objects that do not have any user ID.
  if (empty($account->uid)) {
      return;
  }

  $account2 = user_load($account->uid);
  if (!empty($account2->ed_field_full_name['und'][0]['safe_value'])) {
    $name = $account2->ed_field_full_name['und'][0]['safe_value'];
  }
}

/**
 * Returns translated node type name by node type.
 * If type is not known a general name content will be used instead.
 *
 * @param string  $node_type  Node type (machine name)
 * @param boolean $capitalize Capitalize words or not
 *
 * @return string
 */
function edidaktikum_get_node_type_name($node_type, $capitalize = FALSE) {
  $node_type_name = t('content');
  switch ($node_type) {
  case "ed_blog":
    $node_type_name = t('blog post');
    break;
  case "ed_bookmark":
    $node_type_name = t('bookmark');
    break;
  case "ed_event":
    $node_type_name = t('event');
    break;
  case "ed_news":
    $node_type_name = t('news');
    break;
  case "ed_learning_resource":
    $node_type_name = t('learning resource');
    break;
  case "ed_page":
    $node_type_name = t('page');
    break;
  case "ed_forum":
    $node_type_name = t('discussion');
    break;
  case "ed_file":
    $node_type_name = t('file');
    break;
  case "ed_portfolio":
    $node_type_name = t('portfolio');
    break;
  case "ed_task":
    $node_type_name = t('task');
    break;
  case "ed_answer":
    $node_type_name = t('answer');
    break;
  }

  if ($capitalize) {
    $node_type_name = ucwords($node_type_name);
  }

  return $node_type_name;
}

/**
 * Returns node title. Handles special case of ed_answer node type
 * that does not have a title of its own.
 *
 * @param object $node A node object passed by reference.
 *
 * @return string
 */
function edidaktikum_get_node_title(&$node) {
  if ('ed_aswer' == $node->type) {
    return ed_answer_get_answer_title($node);
  }

  return $node->title;
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function edidaktikum_ctools_plugin_directory($module, $plugin) {
  if(('content_types' == $plugin && 'ctools' == $module)) {
    return 'plugins/' . $plugin;
  }
}

/**
 * Ajax endpoint for add/remove node like.
 */
function edidaktikum_node_like($nid) {
  $account = $GLOBALS['user'];
  $response = array(
    'success' => FALSE,
  );

  $count = db_select('ed_node_like', 'enl')
    ->fields('enl', array('nid'))
    ->condition('enl.nid', $nid)
    ->condition('enl.uid', $account->uid)
    ->countQuery()
    ->execute()->fetchField();

  if (!$count) {
    db_insert('ed_node_like')
      ->fields(array(
        'nid' => $nid,
        'uid' => $account->uid,
        'timestamp' => REQUEST_TIME,
      ))
      ->execute();

    $response['success'] = TRUE;
  } else {
    $deleted = db_delete('ed_node_like')
      ->condition('nid', $nid)
      ->condition('uid', $account->uid)
      ->execute();

    if ($deleted) {
      $response['success'] = TRUE;
    }
  }

  if ($response['success']) {
    $likes = db_select('ed_node_like', 'enl')
      ->fields('enl', array('uid'))
      ->condition('enl.nid', $nid)
      ->countQuery()->execute()->fetchField();
    $response['count'] = $likes;
  }

  drupal_json_output($response);
}

/**
 * Determines if current case is a special comment delete one and
 * the user is allowed to delete a comment.
 * The logic is everyone is allowed to delete own comments and a
 * teacher role user is allowed to delte comments by students (any
 * user having no special roles).
 *
 * @param Object $comment Comment object
 * @return boolean
 */
function _edidaktikum_can_special_delete_comment(&$comment) {
  if (!user_is_logged_in()) {
    return FALSE;
  }
  $account = $GLOBALS['user'];

  if ($account->uid === $comment->uid) {
    // Show delete link to owner
    return TRUE;
  } else if (in_array('teacher', $account->roles)) {
    $owner = user_load($comment->uid);
    // Show delete link to teacher if creator is a student
    if (!(in_array('teacher', $owner->roles) || in_array('administrator', $owner->roles))) {
      return TRUE;
    }
  }

  return FALSE;
}

/**
 * Implements hook_comment_view_alter().
 */
function edidaktikum_comment_view_alter(&$build) {
  if (!user_is_logged_in()) {
    return;
  }

  if (isset($build['links']['comment']['#links']['comment-delete'])) {
    return;
  }

  $comment = $build['#comment'];

  if (_edidaktikum_can_special_delete_comment($comment)) {
    $build['links']['comment']['#links']['comment-delete'] = array(
      'title' => t('delete'),
      'href' => "comment/$comment->cid/delete",
      'html' => TRUE,
    );
  }
}

/**
 * Implements hook_user_logout().
 */
function edidaktikum_user_logout($account){
  user_cookie_save(array('edidaktikum.logoff' => '1'));
}

/**
 * Determines if comment can be removed.
 * Used as an access check.
 * @param int $cid Comment id
 * @return boolean
 */
function edidaktikum_comment_delete_access($cid) {
  if (user_access('administer comments')) {
    return TRUE;
  }

  if (!user_is_logged_in()) {
    return FALSE;
  }

  $comment = comment_load($cid);

  return _edidaktikum_can_special_delete_comment($comment);
}

/**
 * Implements hook_menu_alter().
 */
function edidaktikum_menu_alter(&$items) {
  if (user_is_logged_in()) {
    $items['comment/%/delete']['access callback'] = 'edidaktikum_comment_delete_access';
    $items['comment/%/delete']['access arguments'] = array(1);
  }
}

/**
Implements hook_pathauto_alias_alter.
Set the language of our alias to neutral so that the alias is generated for all languages.
We do not force language neutral if we have a node type being managed by other
translation modules so we return early.
*/
function edidaktikum_pathauto_alias_alter(&$alias, array &$context) {
  if ((module_exists('i18n_node')
    && i18n_node_type_enabled($context['data']['node']->type))
    || (module_exists('entity_translation')
    && entity_translation_node_supported_type($context['data']['node']->type))) {
    return;
  }
  $context['language'] = LANGUAGE_NONE;
}



function ed_get_likes($nid){
  $likescount = db_select('ed_node_like', 'enl')
      ->fields('enl', array('uid'))
      ->condition('enl.nid', $nid)
      ->countQuery()->execute()->fetchField();
  
  return $likescount;
}

function ed_get_views($nid){
  $viewscount = db_select('node_counter', 'nc')
    ->fields('nc', array('totalcount'))
    ->condition('nid', $nid)
    ->execute()->fetchField();
  if($viewscount>0){
    return $viewscount;
  }else{
    return 0;
  }
  
}
/*
function edidaktikum_views_query_alter(&$view, &$query){
  dpm($view, __FUNCTION__);
  dpm($query, __FUNCTION__);
}*/

//  used for arrays of keyed arrays
//  concentrates a member of the keyed arrays into an array
//  useful for things like left joined sql results
//  example:
//    ed_util_array_concentrate_member([ ['id' => 1, 'value' => 1], ['id' => 1, 'value' => 2] ], 'id', 'value')
//    returns: ['id' => 1, 'value' => [1, 2]];
function ed_util_array_concentrate_members($arr, $primary_key, $concentrate_keys) {
  $map = [];
  $ret = [];

  foreach($arr as &$item) {
    $key = $item[$primary_key];

    if (!isset($map[$key])) {
      foreach($concentrate_keys as &$concentrate_key) {
        $item[$concentrate_key] = empty($item[$concentrate_key]) ? [] : [ $item[$concentrate_key] ];
      }
      $ret []=& $item;
      $map[$key] =& $item;
    } else {
      $original =& $map[$key];
      foreach($concentrate_keys as &$concentrate_key) {
        if (!empty($item[$concentrate_key])) {
          if (!in_array($item[$concentrate_key], $original[$concentrate_key])) {
            $original[$concentrate_key] []= $item[$concentrate_key];
          }
        }
      }
    }
  }

  return $ret;
}


//  used for arrays of keyed arrays
//  concentrates a member of the keyed arrays into an array
//  useful for things like left joined sql results
//  example:
//    ed_util_array_concentrate_member([ ['id' => 1, 'value' => 1], ['id' => 1, 'value' => 2] ], 'id', 'value')
//    returns: ['id' => 1, 'value' => [1, 2]];
function ed_util_array_concentrate_member($arr, $primary_key, $concentrate_key) {
  $map = [];
  $ret = [];

  foreach($arr as &$item) {
    $key = $item[$primary_key];

    if (!isset($map[$key])) {
      $item[$concentrate_key] = empty($item[$concentrate_key]) ? [] : [ $item[$concentrate_key] ];
      $ret []=& $item;
      $map[$key] =& $item;
    } else {
      $original =& $map[$key];
      if (!empty($item[$concentrate_key])) $original[$concentrate_key] []= $item[$concentrate_key];
    }
  }

  return $ret;
}

//  used for arrays of keyed arrays
//  renames a key of the keyed arrays in array
function ed_util_rename_key_of_arrays($arr, $old_name, $new_name) {
  foreach ($arr as &$item) {
    $item[$new_name] = $item[$old_name];
    unset($item[$old_name]);
  }
  return $arr;
}

function ed_get_user($uid) {
  $q = db_select('users', 'u');
  $q->condition('u.uid', $uid);
  $q->fields('u', ['uid', 'data']);
  $q->leftJoin('field_data_ed_field_full_name', 'fn', 'fn.entity_id = u.uid');
  $q->fields('fn', ['ed_field_full_name_value']);
  $q->leftJoin('field_data_ed_field_study_group', 'sg', 'sg.entity_id = u.uid');
  $q->fields('sg', ['ed_field_study_group_value']);
  $user = $q->execute()->fetchAll(PDO::FETCH_ASSOC);
  unset($q);

  //  change names of things + concentrate
  $user = ed_util_array_concentrate_member($user, 'uid', 'study_groups');
  $user = ed_util_rename_key_of_arrays($user, 'ed_field_full_name_value', 'full_name');
  $user = ed_util_rename_key_of_arrays($user, 'ed_field_study_group_value', 'study_groups');
  $user = $user[0];

  //  if no name given, try fetch from hybridauth data
  if ($user['full_name'] == NULL) {
    $data = unserialize($user['data']);
    if (isset($data['hybridauth']['displayName'])) {
      $user['full_name'] = $data['hybridauth']['displayName'];
    }
  }

  return $user;
}

//  gets group members ['uid']
//  $gid: the group id
//  $b_full_name: optionally adds full names ['full_name']
//  $b_roles: optionally adds group roles ['roles']
//  $b_study_groups_ optionally adds study groups ['study_groups']
function ed_get_group_members($gid, $b_full_name = false, $b_roles = false, $b_study_groups = false) {
  //  get group members
  $q = db_select('og_membership', 'ogm');
  $q->condition('ogm.gid', $gid);
  $q->condition('ogm.entity_type', 'user');
  $q->join('users', 'u', 'u.uid = ogm.etid AND u.status = 1');
  $q->fields('u', ['uid']);

  //  optionally with full names
  if ($b_full_name) {
    $q->leftJoin('field_data_ed_field_full_name', 'fn', 'fn.entity_id = ogm.etid');
    $q->fields('fn', ['ed_field_full_name_value']);
    //  $q->orderBy('ed_field_full_name_value', 'ASC'); cant order by name if doesn't exist
  }

  //  optionally with study groups
  if ($b_study_groups) {
    $q->leftJoin('field_data_ed_field_study_group', 'sg', 'sg.entity_id = ogm.etid');
    $q->fields('sg', ['ed_field_study_group_value']);
  }

  $members = $q->execute()->fetchAll(PDO::FETCH_ASSOC);
  unset($q);

  //  if full name not present, get data from user blob
  if ($b_full_name) {
    $missing = [];
    foreach ($members as &$member) {
      if ($member['ed_field_full_name_value'] == NULL) {
        $missing []= $member['uid'];
      }
    }
    
    if (count($missing) > 0) {
      $members_with_datas = db_query('SELECT uid, data FROM users WHERE uid IN (:uids)', [':uids' => $missing])->fetchAll(PDO::FETCH_ASSOC);
      foreach ($members_with_datas as &$member_with_data) {
        $data = unserialize($member_with_data['data']);
        $display_name = $data['hybridauth']['displayName'];
        foreach ($members as &$member) {
          if ($member['uid'] == $member_with_data['uid']) {
            $member['ed_field_full_name_value'] = $display_name;
            break;
          }
        }
      }
    }
  }

  //  order
  if ($b_full_name) {
    usort($members, function($a, $b) {
      return strnatcasecmp( $a['ed_field_full_name_value'], $b['ed_field_full_name_value'] );
    });
  }

  //  fetch roles
  if ($b_roles) {

    //  get group creator id
    $q = db_select('node', 'n');
    $q->condition('n.nid', $gid);
    $q->fields('n', ['uid']);
    $creator_uid = $q->execute()->fetchCol()[0];
    unset($q);

    //  get group role names
    $og_role_names = [];
    $q = db_select('og_role', 'ogr');
    $q->fields('ogr', ['rid', 'name']);
    $tmp = $q->execute()->fetchAll(PDO::FETCH_ASSOC);
    unset($q);
    foreach ($tmp as $role) $og_role_names[$role['rid']] = $role['name'];

    //  process members
    foreach($members as &$member) {
      //  from og user roles
      $q = db_select('og_users_roles', 'ogur');
      $q->condition('uid', $member['uid']);
      $q->condition('gid', $gid);
      $q->fields('ogur', ['rid']);
      $role_ids = $q->execute()->fetchCol();
      $member['roles'] = [];
      foreach($role_ids as $id) array_push($member['roles'], $og_role_names[$id]);

      //  or if creator
      if ($member['uid'] == $creator_uid) array_push($member['roles'], OG_ADMINISTRATOR_ROLE);
    }
  }

  //  roll up
  if ($b_full_name) {
    $members = ed_util_rename_key_of_arrays($members, 'ed_field_full_name_value', 'full_name');
  }

  if ($b_study_groups) {
    $members = ed_util_rename_key_of_arrays($members, 'ed_field_study_group_value', 'study_groups');
    $members = ed_util_array_concentrate_member($members, 'uid', 'study_groups');
  }

  return $members;
}

function ed_filter_admins(&$members) {
  $admins = [];
  for ($i = count($members) - 1; $i >= 0; $i--) {
    if (in_array(OG_ADMINISTRATOR_ROLE, $members[$i]["roles"])) {
      $admins []= $members[$i];
      unset($members[$i]);
    }
  }
  return $admins;
}

//  gets group tasks ['nid', 'title']
//  $gid: the group id
//  $b_due_date: optionally adds due dates ['due_date']
//  $b_study_group: optionally adds study groups ['study_groups']
//  $b_targeted_members: optionally adds targeted members ['targeted_member_ids']
function ed_get_group_tasks($gid, $b_due_date = false, $b_study_groups = false, $b_targeted_members = false) {
  //  get group tasks
  $q = db_select('og_membership', 'ogm');
  $q->condition('ogm.gid', $gid);
  $q->condition('ogm.entity_type', 'node');
  $q->join('node', 'n', 'n.nid = ogm.etid AND n.type = \'ed_task\' AND n.status = 1');
  $q->fields('n', ['nid', 'title']);

  //  optionally with due date
  if ($b_due_date) {
    $q->join('field_data_ed_task_due_date', 'dd', 'dd.entity_id = ogm.etid');
    $q->fields('dd', ['ed_task_due_date_value']);
  }

  //  optionally with study groups
  if ($b_study_groups) {
    $q->leftJoin('field_data_ed_task_field_study_group', 'sg', 'sg.entity_id = ogm.etid');
    $q->fields('sg', ['ed_task_field_study_group_value']);
  }

  //  optionally with targeted members
  if ($b_targeted_members) {
    $q->leftJoin('field_data_ed_field_to_group_member', 'tm', 'tm.entity_id = ogm.etid');
    $q->fields('tm', ['ed_field_to_group_member_target_id']);
  }


  $tasks = $q->execute()->fetchAll(PDO::FETCH_ASSOC);

  if ($b_study_groups) {
    $tasks = ed_util_rename_key_of_arrays($tasks, 'ed_task_field_study_group_value', 'study_groups');
    $tasks = ed_util_array_concentrate_member($tasks, 'nid', 'study_groups');
  }

  if ($b_targeted_members) {
    $tasks = ed_util_rename_key_of_arrays($tasks, 'ed_field_to_group_member_target_id', 'targeted_member_ids');
    $tasks = ed_util_array_concentrate_member($tasks, 'nid', 'targeted_member_ids');
  }

  if ($b_due_date) $tasks = ed_util_rename_key_of_arrays($tasks, 'ed_task_due_date_value', 'due_date');


  return $tasks;
}

//  checks if task is applicable to member
//  $task: result item of ed_get_group_tasks with study groups and targeted member ids
//  $member: result item of ed_get_group_members with study groups
function ed_is_task_applicable($task, $member) {
  $applicable = true;                                             //  default true

  if (count($task['study_groups']) > 0) {
    $applicable = false;                                          //  excluded by presence of groups
    foreach ($member['study_groups'] as $study_group) {
      if (in_array($study_group, $task['study_groups'])) {
        $applicable = true;                                     //  included if member is in group
        break;
      }
    }

    if (count($task['targeted_member_ids']) > 0) {
      foreach($task['targeted_member_ids'] as $tid) {
        if ($tid == $member['uid']) {
          $applicable = true;                                     //  included if member is targeted
          break;
        }
      }
    }
  }

  return $applicable;
}

//  gets a task answer ['nid', 'created', 'changed']
//  $task_id: the task id
//  $uid: the user id
//  $b_content: optionally adds answer content ['content']
//  $group_members: optionally adds answer status and comment ['status', 'grade']
//  if provided with the output of ed_get_group_members with roles
function ed_get_answer($task_id, $uid, $b_content = false, $group_members = false) {

  //  find answer id from task id and user id
  $q = db_select('field_data_field_ref_to_task', 'rt');
  $q->condition('rt.field_ref_to_task_target_id', $task_id);
  $q->join('node', 'n', 'n.nid = rt.entity_id AND n.uid = :uid AND n.status = 1', ['uid' => $uid]);
  $q->fields('n', ['nid', 'created', 'changed']);
  $q->range(0, 1);

  //  optionally with content
  if ($b_content) {
    $q->join('field_data_ed_field_content', 'fc', 'fc.entity_id = rt.entity_id');
    $q->fields('fc', ['ed_field_content_value']);
  }

  $answers = $q->execute()->fetchAll(PDO::FETCH_ASSOC);
  unset($q);

  //  if no answer
  if (count($answers) == 0) return ['status' => 'unanswered'];
  $answer = $answers[0];

  //  process
  if ($b_content) {
    $answer['content'] = $answer['ed_field_content_value'];
    unset($answer['ed_field_content_value']);
  }

  //  if comment and grade
  if ($group_members !== false) {
    //  get admin uid's
    $admin_uids = [];
    foreach ($group_members as $member) {
      if (in_array(OG_ADMINISTRATOR_ROLE, $member['roles'])) array_push($admin_uids, $member['uid']);
    }


    //  get all comments regarding the answer node ordered backwards chronologically
    $q = db_select('comment', 'c');
    $q->condition('nid', $answer['nid']);
    $q->fields('c', ['uid']);
    $q->orderBy('created', 'DESC');

    $q->leftJoin('field_data_ed_answer_grade', 'fg', 'fg.entity_id = c.cid');
    $q->fields('fg', ['ed_answer_grade_value']);

    $q->leftJoin('field_data_ed_answer_status', 'fs', 'fs.entity_id = c.cid');
    $q->fields('fs', ['ed_answer_status_value']);

    $comments = $q->execute()->fetchAll(PDO::FETCH_ASSOC);
    unset($q);

    //  get last grade from an admin role user
    $answer['grade'] = 0;
    for ($i = 0; $i < count($comments); $i++) {
      if ($comments[$i]['ed_answer_grade_value'] != NULL && in_array($comments[$i]['uid'], $admin_uids)) {
        $answer['grade'] = $comments[$i]['ed_answer_grade_value'];
        break;
      }
    }

    //  get last status from an admin role user
    $answer['status'] = 'unchecked';
    for ($i = 0; $i < count($comments); $i++) {
      if ($comments[$i]['ed_answer_status_value'] != NULL && in_array($comments[$i]['uid'], $admin_uids)) {
        $answer['status'] = $comments[$i]['ed_answer_status_value'];
        break;
      }
    }

    unset ($q);
  }

  return $answer;
}

function ed_get_taxonomy_tree($vid) {
    $q = db_select("taxonomy_term_data", "td");
    $q->fields("td", ["tid", "name", "weight"]);
    $q->condition("format", "plain_text");
    $q->condition("vid", $vid);
    $q->join("taxonomy_term_hierarchy", "h", "h.tid = td.tid");
    $q->fields("h", ["parent"]);
    $nodes = $q->execute()->fetchAll(PDO::FETCH_ASSOC);
    unset($q);
    usort($nodes, function($a, $b) {
      if ($a["parent"] == $b["parent"]) {
        return (intval($a["weight"]) - intval($b["weight"]));
      } else {
        return (intval($a["parent"]) - intval($b["parent"]));
      }
    });


    $root = ["tid" => "0", "name" => "", "children" => []];
    $map = ["0" =>& $root];

    foreach ($nodes as &$node) {
      $n = ["tid" => $node["tid"], "name" => $node["name"], "children" => []];
      $map[$node["parent"]]["children"] []=& $n;
      $map[$node["tid"]] =& $n;
      unset($n);
    }

    return $root;
}


